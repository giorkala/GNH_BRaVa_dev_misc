"""
Snakefile pipeline for the phasing common and rare variants with SHAPEIT5

The working directory will be the one from where this script will be executed
The pipeline consists of 4 small steps (conceptually, might be tough computationally)
    1) phase common for the whole cohort
    2) phase rare for the whole cohort, in chunks
    3) phase trios (both common and rare variants)
    4) assess phasing and get files with the PP distribution

#### Required input ####
1. Prepared BCF files, per chromosome, for {trios,notrios} x {common,rare} (ie 4x22 files). 
    These can be generated by `smk_01_prep_all_bcf.sh`. See that file for more. 
2. {TAG}.100trios.pedigree: a list of {child,father,mother} triplets for trio phasing
3. Genetic maps and lists of chunks, per chromosome (see the corresponding scripts)
4. A few parameters for Shapeit5 which are already set

Check the `README.md` for more details.

GK - Sep 26th, 2023
"""

## General parameters ##
WORK_DIR="/FIXTHIS/WORK_DIR"
TAG="GNH_39k_New"

rule phase_common:
    resources:
        mem_mb=16000,
        threads=10
    input:
        inputBCF = "{wd}/sandbox/{tag}.notrios.merged_WES_GSA.chr{chrom}.bcf",
    output:
        phasedBCF = "{wd}/phased_genotypes_common/{tag}.notrios.phased_common.chr{chrom}.bcf"
    run:
        shell("bash smk_02_phase_common.sh {wildcards.chrom} {input.inputBCF} {TAG}.notrios")

rule phase_rare:
    resources:
        mem_mb=16000,
        threads=5
    input:
        inputBCF = "{wd}/sandbox/{tag}.notrios.rare_prepared.chr{chrom}.bcf",
        scaffold = rules.phase_common.output.phasedBCF
    output:
        phasedBCF = "{wd}/phased_genotypes_rare/{tag}.notrios.phased_rare.chr{chrom}.bcf"
    run:
        shell("bash smk_03_phase_rare.sh {wildcards.chrom} {input.scaffold} {input.inputBCF} {TAG}.notrios")

rule phase_trios:
    resources:
        mem_mb=16000,
        threads=10
    input: 
        input_comn = "{wd}/sandbox/{tag}.trios.merged_WES_GSA.chr{chrom}.bcf",
        input_rare = "{wd}/sandbox/{tag}.trios.rare_prepared.chr{chrom}.bcf"
    output:
        phased_comn = "{wd}/phased_genotypes_common/{tag}.trios.phased_common.chr{chrom}.bcf",
        phased_rare = "{wd}/phased_genotypes_rare/{tag}.trios.phased_rare.chr{chrom}.bcf"
    run:
        shell("bash smk_02_phase_common.sh {wildcards.chrom} {input.input_comn} {TAG}.trios {TAG}.100trios.pedigree"),
        shell("bash smk_03_phase_rare.sh {wildcards.chrom} {output.phased_comn} {input.input_rare} {TAG}.trios")

rule assess_phasing_common:
    resources:
        threads=5
    input:
        phased_all   = rules.phase_common.output.phasedBCF,
        phased_trios = rules.phase_trios.output.phased_comn
    output:
        var_ser = "{wd}/phasing_assessment/{tag}.assess_common.chr{chrom}.variant.switch.txt.gz"
    run:
        prefix = WORK_DIR + "/phasing_assessment/" + TAG
        shell("bash smk_04_assess_phasing.sh common {wildcards.chrom} {input.phased_trios} {input.phased_all} {TAG}.100trios.pedigree {prefix}")

rule assess_phasing_rare:
    resources:
        threads=5
    input:
        phased_all   = rules.phase_rare.output.phasedBCF,
        phased_trios = rules.phase_trios.output.phased_rare
    output:
        var_ser = "{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz",
        pp_vals = "{wd}/phasing_assessment/{tag}.summary.chr{chrom}.mac1.gz"
    run:
        prefix = WORK_DIR + "/phasing_assessment/" + TAG
        shell("bash smk_04_assess_phasing.sh rare {wildcards.chrom} {input.phased_trios} {input.phased_all} {TAG}.100trios.pedigree {prefix}")
        shell("bash smk_04_assess_phasing.sh getpp {wildcards.chrom} {input.phased_all} {prefix}.summary")


rule run_all:
    input:
        # expand("{wd}/phased_genotypes_common/{tag}.trios.phased_common.chr{chrom}.bcf", chrom=range(22,23), wd={WORK_DIR}, tag={TAG}),
        expand("{wd}/phased_genotypes_rare/{tag}.trios.phased_rare.chr{chrom}.bcf", chrom=range(18,19), wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phased_genotypes_rare/{tag}.notrios.phased_rare.chr{chrom}.bcf", chrom=range(22,23), wd={WORK_DIR}, tag={TAG}),    
        expand("{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz", chrom=range(18,19), wd={WORK_DIR}, tag={TAG}),
        expand("{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz", chrom=range(20,23), wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phasing_assessment/{tag}.assess_common.chr{chrom}.variant.switch.txt.gz", chrom={CHR}, wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phasing_assessment/{tag}.summary.chr{chrom}.mac1.gz", chrom={CHR}, wd={WORK_DIR}, tag={TAG}),
