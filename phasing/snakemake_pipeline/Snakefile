"""
Snakefile pipeline for the phasing common and rare variants with SHAPEIT5

The working directory will be the one from where this script will be executed
The pipeline consists of 4 small steps (conceptually, might be tough computationally)
    1) phase trios (both common and rare variants)
    2) phase common for the whole cohort
    3) phase rare for the whole cohort, in chunks
    4) assess phasing and get files with the PP distribution

#### Required input ####
1. Prepared BCF files, per chromosome, for {trios,notrios} x {common,rare} (ie 4x22 files). 
    These can be generated by `smk_01_prep_all_bcf.sh`. See that file for more. 
2. {TAG}.100trios.pedigree: a list of {child,father,mother} triplets for trio phasing
3. Genetic maps and lists of chunks, per chromosome (see the corresponding scripts)
4. A few parameters for Shapeit5 which are already set

#### Important notes ####
* File prep is not included here as is tricky; this could be performed with `smk_00_merge_wes_array.sh` [TODO]  
* Each script contains a few params, such as paths to genetic maps, or chunk lists.
* Software dependencies: bcftools (+HTSlib), SHAPEIT5, snakemake (+Python); 
* I'm currently using a combination of binaries and modules for Shapeit5 (to deal with issues 34,56), please choose what's best
* The SER analysis is performed using the `switch` tool provided by SHAPEIT5 - this might need to change [TODO]

#### How to - LSF ####
* the following will start the pipeline and submit all jobs with all the jobs required:
`snakemake --cluster "bsub -M 16G -R 'select[mem>16G] rusage[mem=16G]' -n10 -G team281 -q normal -o run_all.stdout -e run_all.stderr" --jobs 10 --latency-wait 10 -T 2 run_all`
* first run the following the initialise the required folders:
`mkdir -p phased_genotypes_common phased_genotypes_rare phasing_assessment sandbox`

GK - Sep 26th, 2023
"""

## General parameters ##
WORK_DIR="/FIXTHIS/WORK_DIR"
TAG="GNH_39k_New"

rule phase_common:
    resources:
        mem_mb=16000,
        threads=10
    input:
        inputBCF = "{wd}/sandbox/{tag}.notrios.merged_WES_GSA.chr{chrom}.bcf",
    output:
        phasedBCF = "{wd}/phased_genotypes_common/{tag}.notrios.phased_common.chr{chrom}.bcf"
    run:
        shell("bash smk_02_phase_common.sh {wildcards.chrom} {input.inputBCF} {TAG}.notrios")

rule phase_rare:
    resources:
        mem_mb=16000,
        threads=5
    input:
        inputBCF = "{wd}/sandbox/{tag}.notrios.rare_prepared.chr{chrom}.bcf",
        scaffold = rules.phase_common.output.phasedBCF
    output:
        phasedBCF = "{wd}/phased_genotypes_rare/{tag}.notrios.phased_rare.chr{chrom}.bcf"
    run:
        shell("bash smk_03_phase_rare.sh {wildcards.chrom} {input.scaffold} {input.inputBCF} {TAG}.notrios")

rule phase_trios:
    resources:
        mem_mb=16000,
        threads=10
    input: 
        input_comn = "{wd}/sandbox/{tag}.trios.merged_WES_GSA.chr{chrom}.bcf",
        input_rare = "{wd}/sandbox/{tag}.trios.rare_prepared.chr{chrom}.bcf"
    output:
        phased_comn = "{wd}/phased_genotypes_common/{tag}.trios.phased_common.chr{chrom}.bcf",
        phased_rare = "{wd}/phased_genotypes_rare/{tag}.trios.phased_rare.chr{chrom}.bcf"
    run:
        shell("bash smk_02_phase_common.sh {wildcards.chrom} {input.input_comn} {TAG}.trios {TAG}.100trios.pedigree"),
        shell("bash smk_03_phase_rare.sh {wildcards.chrom} {output.phased_comn} {input.input_rare} {TAG}.trios")

rule assess_phasing_common:
    resources:
        threads=5
    input:
        phased_all   = rules.phase_common.output.phasedBCF,
        phased_trios = rules.phase_trios.output.phased_comn
    output:
        var_ser = "{wd}/phasing_assessment/{tag}.assess_common.chr{chrom}.variant.switch.txt.gz"
    run:
        prefix = WORK_DIR + "/phasing_assessment/" + TAG
        shell("bash smk_04_assess_phasing.sh common {wildcards.chrom} {input.phased_trios} {input.phased_all} {prefix}")

rule assess_phasing_rare:
    resources:
        threads=5
    input:
        phased_all   = rules.phase_rare.output.phasedBCF,
        phased_trios = rules.phase_trios.output.phased_rare
    output:
        var_ser = "{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz",
        pp_vals = "{wd}/phasing_assessment/{tag}.summary.chr{chrom}.mac1.gz"
    run:
        prefix = WORK_DIR + "/phasing_assessment/" + TAG
        shell("bash smk_04_assess_phasing.sh rare {wildcards.chrom} {input.phased_trios} {input.phased_all} {prefix}")
        shell("bash smk_04_assess_phasing.sh getpp {wildcards.chrom} {input.phased_all} {prefix}.summary")


rule run_all:
    input:
        # expand("{wd}/phased_genotypes_common/{tag}.trios.phased_common.chr{chrom}.bcf", chrom=range(22,23), wd={WORK_DIR}, tag={TAG}),
        expand("{wd}/phased_genotypes_rare/{tag}.trios.phased_rare.chr{chrom}.bcf", chrom=range(18,19), wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phased_genotypes_rare/{tag}.notrios.phased_rare.chr{chrom}.bcf", chrom=range(22,23), wd={WORK_DIR}, tag={TAG}),    
        expand("{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz", chrom=range(18,19), wd={WORK_DIR}, tag={TAG}),
        expand("{wd}/phasing_assessment/{tag}.assess_rare.pp0.50.chr{chrom}.variant.switch.txt.gz", chrom=range(20,23), wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phasing_assessment/{tag}.assess_common.chr{chrom}.variant.switch.txt.gz", chrom={CHR}, wd={WORK_DIR}, tag={TAG}),
        # expand("{wd}/phasing_assessment/{tag}.summary.chr{chrom}.mac1.gz", chrom={CHR}, wd={WORK_DIR}, tag={TAG}),
